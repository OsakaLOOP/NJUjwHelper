<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‹å—å“ªé€‰è¯¾åŠ©æ‰‹</title>
    <script src="vue.global.js"></script>
    <script src="html2canvas.min.js"></script>
    <style>
        body { font-family: "Microsoft YaHei", sans-serif; margin: 0; padding: 0; background: #f5f5f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: #630560; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: baseline; }
        button { background: #39C5BB; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.secondary { background: #ccc; }
        button.danger { background: #b00020; color: white; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }

        /* Navigation */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-tab { padding: 10px 20px; background: #ddd; border-radius: 4px; cursor: pointer; }
        .nav-tab.active { background: #630560; color: white; }

        /* Search */
        .search-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px; }
        input:not([type="checkbox"]), select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; cursor: pointer; }
        .results-list { max-height: 400px; overflow-y: auto; margin-top: 10px; }
        .result-item { border-bottom: 1px solid #eee; padding: 10px; display: flex; align-items: start; gap: 10px; }

        /* Groups */
        .group-item { border: 1px solid #ddd; margin-bottom: 10px; border-radius: 4px; overflow: hidden; }
        .group-header { background: #f0f0f0; padding: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .group-body { padding: 10px; display: none; }
        .group-body.open { display: block; }

        /* Timetable */
        .timetable { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        .timetable th, .timetable td { border: 1px solid #ddd; padding: 5px; text-align: center; font-size: 0.85rem; height: 40px; }
        .timetable th { background: #f9f9f9; }
        .cell-active { background-color: #bbdefb; color: #0d47a1; font-size: 0.75rem; border-radius: 2px; height: 100%; width: 100%;}
        .cell-conflict { background-color: #ffcdd2; color: #b71c1c; }

        /* Toast */
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 10px 20px; border-radius: 4px; z-index: 1000; display: none; }
        .toast.error { background: #b00020; }
        .toast.success { background: #4caf50; }

        /* Alternatives Modal/Overlay */
        .alt-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .alt-card { background: white; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .alt-item { padding: 10px; border-bottom: 1px solid #eee; }
        .alt-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <h1>
                ğŸ‹å—å“ªé€‰è¯¾åŠ©æ‰‹
                <span v-if="groups.length > 0" style="font-size: 0.8em; margin-left: 10px; font-weight: normal;">å½“å‰ç»„æ•°: {{ groups.length }}</span>
                <span style="font-size: 0.7rem; font-weight: normal; margin-left: 15px; opacity: 0.8;">æœ¬appæ‰€æœ‰å†…å®¹åœ¨æœ¬åœ°å¤„ç†, ä»…è·å–å¿…è¦çš„cookie, ä¸å­˜å‚¨ç”¨æˆ·å¯†ç . æ‰€æœ‰å†…å®¹ä»…ä¸ºç®—æ³•ç”Ÿæˆ, ä¸ä½œä¸ºå®Œå…¨å‚è€ƒ.</span>
            </h1>
            <div>
                <button @click="saveSession" class="secondary" style="margin-right: 10px;">ä¿å­˜è¿›åº¦</button>
                <button @click="newSession" class="danger">é‡ç½®</button>
            </div>
        </header>

        <div class="container">
            <div class="nav-tabs">
                <div :class="['nav-tab', currentView==='search'?'active':'']" @click="currentView='search'">1. è¯¾ç¨‹æŸ¥è¯¢</div>
                <div :class="['nav-tab', currentView==='planning'?'active':'']" @click="currentView='planning'">2. è§„åˆ’ & ç­–ç•¥</div>
                <div :class="['nav-tab', currentView==='results'?'active':'']" @click="currentView='results'">3. ç»“æœ & è¯¾è¡¨</div>
                <div style="display: flex; align-items: center; font-size: 1rem; color: #888; font-family: 'Consolas', 'Monaco', monospace; letter-spacing: -0.02em;">
                    <span style="display: inline-block; transform: scaleX(-1); margin-right: 5px; font-size: 1.1em;" aria-label="Copyleft icon">&copy;</span>
                    <span>
                        <a href="https://github.com/OsakaLOOP" target="_blank" style="color: inherit; text-decoration: none; border-bottom: 1px solid #eee;">@OsakaLOOP</a>
                        <span style="margin: 0 8px; opacity: 0.4;">|</span>
                        Licensed under 
                        <a href="https://www.gnu.org/licenses/gpl-3.0.html" target="_blank" style="color: #630560; text-decoration: none; font-weight: 600;">GPL v3.0</a>
                        <span style="margin: 0 8px; opacity: 0.4;">|</span>
                        æ•°æ®æº: <a href="https://jw.nju.edu.cn" target="_blank" style="color: #630560; text-decoration: none; font-weight: 600;">å—å¤§æ•™æœå¹³å° - å…¨æ ¡è¯¾ç¨‹è¡¨</a>
                    </span>
                </div>
            </div>

            <!-- View 1: Search -->
            <div v-show="currentView==='search'" class="card">
                <h2>æ·»åŠ å¤‡é€‰è¯¾ç¨‹ç»„</h2>
                <div class="search-grid" style="display: flex; width: 100%; gap: 5; align-items: stretch;">
                    <input 
                        v-model="searchParams.name" 
                        placeholder="è¯¾ç¨‹å (ç©ºæ ¼åˆ†éš”å¤šè¯)" 
                        style="flex: 1; min-width: 0; box-sizing: border-box;"
                    >

                    <select title="ç©ºæ ¼åˆ†éš”å…³é”®è¯å¤„ç†"
                        v-model="searchParams.match_mode" 
                        style="width: auto; flex-shrink: 0; box-sizing: border-box;"
                    >
                        <option value="OR">OR</option>
                        <option value="AND">AND</option>
                    </select>

                    <input 
                        v-model="searchParams.code" 
                        placeholder="è¯¾ç¨‹å·" 
                        style="width: 15ch; flex-shrink: 0; box-sizing: border-box;"
                    >

                    <select 
                        v-model="searchParams.campus" 
                        style="width: auto; flex-shrink: 0; box-sizing: border-box;"
                    >
                        <option value="1">é¼“æ¥¼</option>
                        <option value="2">æµ¦å£</option>
                        <option value="3">ä»™æ—</option>
                        <option value="4">è‹å·</option>
                    </select>

                    <input 
                        v-model="searchParams.semester" 
                        placeholder="å­¦æœŸ" 
                        style="width: 15ch; flex-shrink: 0; box-sizing: border-box;"
                    >

                    <button 
                        @click="doSearch" 
                        :disabled="loading" 
                        style="flex-shrink: 0; white-space: nowrap; box-sizing: border-box;"
                    >
                        {{ loading ? '...' : 'æœç´¢' }}
                    </button>
                </div>

                <div v-if="hasSearched">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <h3>æœç´¢ç»“æœ ({{ filteredSearchResults.length }})</h3>
                        <button @click="createGroup">å°†é€‰ä¸­é¡¹å­˜ä¸ºä¸€ç»„</button>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 10px; margin-top: 10px;">
                        <input v-model="filterText" placeholder="åœ¨ç»“æœä¸­ç­›é€‰ (åç§°/è€å¸ˆ/åœ°ç‚¹)..." style="flex: 1;">
                        <button class="secondary" @click="toggleSelectAll">å…¨é€‰/åé€‰</button>
                    </div>

                    <div v-if="filteredSearchResults.length === 0" style="padding: 20px; text-align: center; color: #666;">
                        {{ searchResults.length === 0 ? 'æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è¯¾ç¨‹ã€‚' : 'å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰è¯¾ç¨‹ã€‚' }}
                    </div>

                    <div class="results-list" v-else>
                        <label v-for="(course, idx) in filteredSearchResults"
                               :key="idx"
                               class="result-item"
                               :style="(course.location_text || '').includes('è‡ªç”±æ—¶é—´') ? { opacity: 0.5, cursor: 'not-allowed' } : {}">
                            <input type="checkbox"
                                   v-model="course.checked"
                                   :disabled="(course.location_text || '').includes('è‡ªç”±æ—¶é—´')">
                            <div>
                                <strong>{{ course.name }}</strong> ({{ course.code }}) <br>
                                <small>è€å¸ˆ: {{ course.teacher }} | åœ°ç‚¹: {{ course.location_text }}</small>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- View 2: Planning -->
            <div v-show="currentView==='planning'" class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>æˆ‘çš„è¯¾ç¨‹ç»„ ({{ groups.length }})</h2>
                    <button class="secondary" @click="openImportModal">æ‰¹é‡å¯¼å…¥</button>
                </div>
                <div v-if="groups.length === 0">æš‚æ— è¯¾ç¨‹ç»„ï¼Œè¯·å…ˆå»æœç´¢æ·»åŠ æˆ–æ‰¹é‡å¯¼å…¥ã€‚</div>

                <div v-for="(group, idx) in groups" :key="group.id" class="group-item">
                    <div class="group-header" @click="group.open = !group.open">
                        <span>
                            <strong>ç»„ {{ idx + 1 }}:</strong> {{ getGroupName(group) }}
                            <small>({{ getActiveCount(group) }}/{{ group.candidates.length }} é€‰ä¸­)</small>
                        </span>
                        <button class="danger" @click.stop="removeGroup(idx)" style="padding: 4px 8px; font-size: 0.8rem;">åˆ é™¤</button>
                    </div>
                    <div :class="['group-body', group.open ? 'open' : '']">
                        <label v-for="(course, cIdx) in group.candidates" :key="cIdx" class="result-item">
                            <input type="checkbox"
                                   v-model="course.selected">
                            <div>
                                {{ course.name }} - {{ course.teacher }} <br>
                                <small>{{ course.location_text }}</small>
                            </div>
                        </label>
                    </div>
                </div>

                <h3>åå¥½è®¾ç½®</h3>
                <label><input type="checkbox" v-model="preferences.avoid_early_morning"> é¿å¼€æ—©å…« (1-2èŠ‚)</label> <br>
                <label><input type="checkbox" v-model="preferences.avoid_weekend"> é¿å¼€å‘¨æœ«</label> <br>
                <div style="margin-top: 10px;">
                    è¯¾ç¨‹åˆ†å¸ƒ:
                    <select v-model="preferences.compactness">
                        <option value="none">æ— æ‰€è°“</option>
                        <option value="high">ç´§å‡‘ (å‡å°‘ç©ºè¯¾)</option>
                        <option value="low">åˆ†æ•£ (å‡åŒ€åˆ†å¸ƒ)</option>
                    </select>
                </div>

                <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                    <label style="font-weight: bold;">
                        <input type="checkbox" v-model="preferences.day_max_limit_enabled">
                        æ—¥æœ€å¤šèŠ‚æ•°é™åˆ¶
                    </label>

                    <div v-if="preferences.day_max_limit_enabled" style="margin-top: 10px; margin-left: 20px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
                        <div style="margin-bottom: 10px;">
                            é™åˆ¶ä¸º:
                            <select v-model.number="preferences.day_max_limit_value" style="width: auto; display: inline-block;">
                                <option :value="0">0 (æ²¡è¯¾)</option>
                                <option :value="2">2</option>
                                <option :value="4">4</option>
                                <option :value="6">6</option>
                            </select> èŠ‚
                        </div>
                        <div>
                            é€‚ç”¨æ—¥æœŸ:
                            <button class="secondary" style="padding: 2px 8px; margin-right: 5px; font-size: 0.8rem;" @click="toggleAllDays(true)">å…¨é€‰</button>
                            <button class="secondary" style="padding: 2px 8px; font-size: 0.8rem;" @click="invertDays()">åé€‰</button>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px;">
                            <label v-for="(day, idx) in ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']" :key="idx" style="cursor: pointer;">
                                <input type="checkbox" v-model="preferences.day_max_limit_days[idx]"> å‘¨{{ day }}
                            </label>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button @click="generateSchedules" style="width: 100%; padding: 15px; font-size: 1.1rem;">ç”Ÿæˆè¯¾è¡¨æ–¹æ¡ˆ</button>
                </div>
            </div>

            <!-- View 3: Results -->
            <div v-show="currentView==='results'" class="card">
                <div v-if="schedules.length === 0">è¯·å…ˆç”Ÿæˆæ–¹æ¡ˆã€‚</div>
                <div v-else>
                    <h3>æ¨èæ–¹æ¡ˆ (æ˜¾ç¤º {{ schedules.length }} ä¸ª / å…± {{ totalCount }} ä¸ªå¯èƒ½æ–¹æ¡ˆ)</h3>
                    <div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;">
                        <button v-for="(sch, idx) in schedules.slice(0, 20)"
                                :key="idx"
                                :class="currentScheduleIdx === idx ? '' : 'secondary'"
                                @click="currentScheduleIdx = idx"
                                style="flex-shrink: 0;">
                            æ–¹æ¡ˆ {{ idx + 1 }} <small>({{ parseInt(sch.score) }}åˆ†)</small>
                        </button>
                    </div>

                    <div id="capture-area" style="background: white; padding: 15px; margin-top: 20px; border: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h2 style="margin:0;">ç¬¬ {{ currentScheduleIdx + 1 }} æ–¹æ¡ˆè¯¾è¡¨</h2>
                            <div>
                                å‘¨æ¬¡: <input type="number" v-model.number="currentWeek" min="1" max="20" style="width: 60px;">
                            </div>
                        </div>

                        <!-- Statistics Section -->
                        <div v-if="schedules[currentScheduleIdx]" style="margin-bottom: 15px; padding: 10px; background: #f0f4c3; border-radius: 4px; font-size: 0.9rem;">
                            <div style="display: flex; gap: 20px; flex-wrap: wrap; font-weight: bold; margin-bottom: 5px;">
                                <span>æ€»å­¦åˆ†: {{ schedules[currentScheduleIdx].stats?.total_credits }}</span>
                                <span>æ€»å­¦æ—¶: {{ schedules[currentScheduleIdx].stats?.total_hours }}</span>
                                <span>å‘¨å¹³å‡å­¦æ—¶: {{ schedules[currentScheduleIdx].stats?.avg_weekly_hours }}</span>
                                <span>æ´»è·ƒå‘¨æ¬¡: {{ schedules[currentScheduleIdx].stats?.week_span }}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #555;">
                                <strong>è¯„åˆ†è¯¦æƒ…:</strong>
                                åŸºå‡†åˆ†: 100
                                <span v-for="(val, key) in schedules[currentScheduleIdx].score_details" :key="key" :style="{color: val < 0 ? 'red' : 'green', marginLeft: '10px'}">
                                    {{ key }}: {{ val >= 0 ? '+' : ''}}{{ val }}
                                </span>
                                <span style="margin-left: 10px; font-weight: bold;">= {{ parseInt(schedules[currentScheduleIdx].score) }}</span>
                            </div>
                        </div>

                        <table class="timetable">
                            <thead>
                                <tr>
                                    <th>èŠ‚æ¬¡</th>
                                    <th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th><th>å‘¨å…­</th><th>å‘¨æ—¥</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="node in 13" :key="node">
                                    <td>{{ node }}</td>
                                    <td v-for="day in 7" :key="day">
                                        <div v-if="getCell(currentScheduleIdx, currentWeek, day-1, node-1)"
                                             class="cell-active"
                                             @click="openAlternatives(getCell(currentScheduleIdx, currentWeek, day-1, node-1))"
                                             style="cursor: pointer;">
                                            <div style="font-weight: bold;">{{ getCell(currentScheduleIdx, currentWeek, day-1, node-1).name }}</div>
                                            <div style="font-size: 0.8em;">{{ getCell(currentScheduleIdx, currentWeek, day-1, node-1).teacher }}</div>
                                            <div style="font-size: 0.8em;">{{ getCell(currentScheduleIdx, currentWeek, day-1, node-1).location }}</div>
                                            <div v-if="getCell(currentScheduleIdx, currentWeek, day-1, node-1).alternatives && getCell(currentScheduleIdx, currentWeek, day-1, node-1).alternatives.length > 1"
                                                 style="background: #1976d2; color: white; border-radius: 10px; padding: 0 4px; font-size: 0.7em; display: inline-block; margin-top: 2px;">
                                                +{{ getCell(currentScheduleIdx, currentWeek, day-1, node-1).alternatives.length - 1 }}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button @click="downloadImage" style="margin-top: 20px;">ä¿å­˜ä¸ºå›¾ç‰‡</button>
                </div>
            </div>
        </div>

        <div class="toast" ref="toast"></div>

        <!-- Alternatives Modal -->
        <div v-if="showAltModal" class="alt-overlay" @click.self="showAltModal = false">
            <div class="alt-card">
                <h3>{{ currentAltCourse ? currentAltCourse.name : '' }} - å¯é€‰è€å¸ˆ</h3>
                <div v-if="currentAltCourse && currentAltCourse.alternatives">
                    <div v-for="(alt, idx) in currentAltCourse.alternatives" :key="idx" class="alt-item">
                        <strong>{{ alt.teacher }}</strong>
                        <div style="color: #666; font-size: 0.9em;">{{ alt.location_text }}</div>
                        <div style="color: #666; font-size: 0.9em;">{{ alt.code }}</div>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: right;">
                    <button @click="showAltModal = false">å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- Import Modal -->
        <div v-if="showImportModal" style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;">
            <div style="background: white; padding: 20px; border-radius: 8px; width: 600px; max-width: 90%; display: flex; flex-direction: column; gap: 10px;">
                <h3>æ‰¹é‡å¯¼å…¥è¯¾ç¨‹</h3>
                <p style="font-size: 0.9em; color: #666;">è¯·ç²˜è´´æ¥è‡ª<a href="https://ehallapp.nju.edu.cn/jwapp/sys/qxfacx/*default/index.do" target="_blank">"å­¦æœŸåŸ¹å…»æ–¹æ¡ˆ"</a>çš„è¡¨æ ¼å†…å®¹ (åŒ…å«è¯¾ç¨‹å·ã€è¯¾ç¨‹åç­‰)</p>
                <textarea v-model="importText" rows="10" placeholder="ç²˜è´´å†…å®¹åˆ°æ­¤å¤„..." style="width: 100%; box-sizing: border-box;"></textarea>

                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>å­¦æœŸ</label>
                        <input v-model="importParams.semester" placeholder="2025-2026-2">
                    </div>
                    <div style="flex: 1;">
                        <label>æ ¡åŒº</label>
                        <select v-model="importParams.campus">
                            <option value="1">é¼“æ¥¼</option>
                            <option value="2">æµ¦å£</option>
                            <option value="3">ä»™æ—</option>
                            <option value="4">è‹å·</option>
                        </select>
                    </div>
                </div>

                <div v-if="importStatus" style="background: #e3f2fd; padding: 10px; border-radius: 4px; color: #0d47a1;">
                    {{ importStatus }}
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                    <button class="secondary" @click="closeImportModal" :disabled="isImporting">å–æ¶ˆ</button>
                    <button @click="startBatchImport" :disabled="isImporting">{{ isImporting ? 'å¯¼å…¥ä¸­...' : 'å¼€å§‹å¯¼å…¥' }}</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
